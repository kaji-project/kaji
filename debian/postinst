#!/bin/bash
#DEBHELPER#

set -e

. /usr/share/debconf/confmodule

case "$1" in
  configure)

    # Git init /etc/shinken
    if [ ! -x /etc/shinken/.git ]
    then
        chown -R shinken:shinken /etc/shinken/
        usermod -s /bin/bash shinken
        usermod -G shinken www-data
        chgrp -R www-data /etc/shinken
        chmod -R g+w /etc/shinken
        cd /etc/shinken/
        su www-data -c 'git config --global user.email "adagios@kaji-project.org"'
        su www-data -c 'git config --global user.name "adagios"'
        su shinken -c 'git config --global user.email "shinken@kaji-project.org"'
        su shinken -c 'git config --global user.name "shinken"'
        su shinken -c 'git init'
        su shinken -c 'git add .'
        su shinken -c 'git commit -a -m "Initial Kaji installation commit"'
    fi
    a2ensite influxdb
    service shinken restart || echo "Failed to restart Shinken. You have to restart Shinken to update its configuration"
    service apache2 reload || echo "Failed to restart Apache2. You have to restart Apache2 to update its configuration"
    lessc -x --include-path=/usr/share/grafana/vendor/bootstrap/less /usr/share/grafana/css/less/bootstrap.light.less > /usr/share/grafana/css/grafana.light.min.css
    lessc -x --include-path=/usr/share/grafana/vendor/bootstrap/less /usr/share/grafana/css/less/bootstrap.dark.less > /usr/share/grafana/css/grafana.dark.min.css
    echo
    echo "Kaji install finished"
    echo
    ;;
  abort-upgrade)
    # Back out of an attempt to upgrade this package FROM THIS VERSION
    # to version $2.  Undo the effects of "prerm upgrade $2".
    :

    ;;
  abort-remove)
    if test "$2" != in-favour; then
      echo "$0: undocumented call to \`postinst $*'" 1>&2
      exit 0
    fi
    # Back out of an attempt to remove this package, which was due to
    # a conflict with package $3 (version $4).  Undo the effects of
    # "prerm remove in-favour $3 $4".
    :

    ;;
  abort-deconfigure)
    if test "$2" != in-favour -o "$5" != removing; then
      echo "$0: undocumented call to \`postinst $*'" 1>&2
      exit 0
    fi
    # Back out of an attempt to deconfigure this package, which was
    # due to package $6 (version $7) which we depend on being removed
    # to make way for package $3 (version $4).  Undo the effects of
    # "prerm deconfigure in-favour $3 $4 removing $6 $7".
    :

    ;;
  *) echo "$0: didn't understand being called with \`$1'" 1>&2
     exit 0;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.
#DEBHELPER#

exit 0

